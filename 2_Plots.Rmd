---
title: "Attempting to replicate Martin's plot with updated SOCSIM data"
output: html_document
author: "..."
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preamble

```{r}
library(tidyverse)
library(data.table)
library(RColorBrewer)
library(extrafont)
library(ggthemes)
library(ggtext)
library(cowplot)
windowsFonts(Times = windowsFont("Times New Roman"))

#setwd("../")

load("Output/reference_table_SweBorn.RData")
load("Output/N_Cohort.RData")
load("Output/temp.RData")

```

#### Plot A1 + A2: Population size (N) over birth cohorts

```{r}
#  I haven't seen this plot 
A1 <- ggplot(data = filter(gather(N_Cohort, key = "Population", value = "N", -IDbirthYear), IDbirthYear >= 1915)) +
  geom_line(mapping = aes(x = IDbirthYear, y = N, color = Population), lwd = 1) +
  geom_area(data=data.frame(x = c(1910,2020), y = c(-50,-1000)), aes(x=x,y=y), fill = "white", alpha = 0.2) +
  coord_cartesian(clip = "off")+
  labs(x = "Birth cohort \n (Age in 2018)", y = "Cohort size (N)", color = "") +
  #scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017)) +
  #scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), sec.axis = sec_axis(~ 2018 - ., name = "Cohort age in 2018", breaks = c(seq(100,10, length.out = 10),1))) +
  scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), labels = paste(c(seq(1920, 2010,by = 10), 2017), "\n", "(",2018 - c(seq(1920, 2010,by = 10), 2017),")")) +
  theme_test() +
  scale_color_manual(values = c("#CC2900", "#fc8d59", "#31a354", "#3182bd"),
                     limits = c("N_ever", "N_sweborn", "N_17", "N_sweparent"),
                     labels = c("  \nEver observed in registers  \n", 
                                "Ever observed in registers,  \nborn in Sweden", 
                                "**Analytical population**  \nEver observed in registers,  \nborn in Sweden,  \nalive in 2018", 
                                "Ever observed in registers,  \nborn in Sweden,  \nalive in 2018,  \nwith two Swedish born parents")) + 
  theme(text = element_text(family = "Times", size = 12),
        legend.position = "bottom",
        legend.text = element_markdown())

A1
```

#### Plot Q: Mean grandchildren per cohort


```{r}
grandchild_table <- reference_table_SweBorn %>% 
  filter(refGroup == "grandchild" & !is.na(refID) & !is.na(refIDbirthYear) & IDbirthYear >= 1915 & IDbirthYear <= 2017) %>%
  mutate(isAlive = refIDdeathYear > 2017) %>%
  setDT() %>% 
  left_join(., temp, by = c("IDbirthYear", "Kon"))

grandchild_table <- distinct(grandchild_table[, .(mean_grandchildren = .N / N_17),keyby = .(IDbirthYear, Kon, isAlive)])


grandchildren_dist_Table <-  reference_table_SweBorn %>%
  filter(refGroup == "grandchild" & IDbirthYear >= 1915 & IDbirthYear <= 2017) %>%
  left_join(., temp, by = c("IDbirthYear", "Kon")) %>%
  mutate(isAlive = refIDdeathYear > 2017) %>%
  setDT

grandchildren_dist_Table_living <- rbind(grandchildren_dist_Table[is.na(refID),.(n_grandchildren = 0),keyby = .(ID, IDbirthYear, Kon, N_17)][,.(freq = .N),keyby = .(IDbirthYear, Kon, N_17, n_grandchildren)],
                                         grandchildren_dist_Table[isAlive == TRUE & !is.na(refID),.(n_grandchildren = .N),keyby = .(ID, IDbirthYear, Kon, N_17)][,.(freq = .N),keyby = .(IDbirthYear, Kon, N_17, n_grandchildren)]) %>%
  mutate(n_grandchildren = ifelse(n_grandchildren > 5 & n_grandchildren < 11, "6-10",ifelse(n_grandchildren > 10,">10",as.character(n_grandchildren))),
         n_grandchildren = factor(n_grandchildren, levels = c(">10","6-10","5","4","3","2","1","0")),
         #n_grandchildren = factor(n_grandchildren, levels = c("0","1","2","3","4","5","6-10",">10")),
         n_grandchildren = fct_recode(n_grandchildren,
                                      "No grandchildren" = "0",
                                      "1 grandchild" = "1",
                                      "2 grandchildren" = "2",
                                      "3 grandchildren" = "3",
                                      "4 grandchildren" = "4",
                                      "5 grandchildren" = "5",
                                      "6-10 grandchildren" = "6-10",
                                      "11 or more grandchildren" = ">10")) %>%
  .[,.(freq =sum(freq)) ,keyby = .(IDbirthYear, Kon,  N_17, n_grandchildren)]%>%
  .[,.(n_grandchildren = n_grandchildren, freq = freq, N_17 = sum(freq), prop = freq /sum(freq)),keyby = .(IDbirthYear, Kon)]

grandchildren_dist_Table <- rbind(grandchildren_dist_Table[is.na(refID),.(n_grandchildren = 0),keyby = .(ID, IDbirthYear, Kon, N_17)][,.(freq = .N),keyby = .(IDbirthYear, Kon, N_17, n_grandchildren)],
                                  grandchildren_dist_Table[!is.na(refID),.(n_grandchildren = .N),keyby = .(ID, IDbirthYear, Kon, N_17)][,.(freq = .N),keyby = .(IDbirthYear, Kon, N_17, n_grandchildren)]) %>%
  mutate(n_grandchildren = ifelse(n_grandchildren > 5 & n_grandchildren < 11, "6-10",ifelse(n_grandchildren > 10,">10",as.character(n_grandchildren))),
         n_grandchildren = factor(n_grandchildren, levels = c(">10","6-10","5","4","3","2","1","0")),
         n_grandchildren = fct_recode(n_grandchildren,
                                      "No grandchildren" = "0",
                                      "1 grandchild" = "1",
                                      "2 grandchildren" = "2",
                                      "3 grandchildren" = "3",
                                      "4 grandchildren" = "4",
                                      "5 grandchildren" = "5",
                                      "6-10 grandchildren" = "6-10",
                                      "11 or more grandchildren" = ">10")) %>%
  .[,.(freq =sum(freq)) ,keyby = .(IDbirthYear, Kon,  N_17, n_grandchildren)]%>%
  .[,.(n_grandchildren = n_grandchildren, freq = freq, N_17 = sum(freq), prop = freq /sum(freq)),keyby = .(IDbirthYear, Kon)]


Q <- ggplot() +
  geom_area(data = grandchild_table, mapping = aes(x = IDbirthYear, y = mean_grandchildren, fill = isAlive), color = "grey30") +
  #geom_line(data = data.frame(IDbirthYear= seq(1980, 2017, by = 1), mean_grandchildren = 0), aes(x = IDbirthYear, y = mean_grandchildren), color = "grey30")+
  geom_area(data=data.frame(x = c(2017-73,2017), y = c(4,4)), aes(x=x,y=y), fill = "white", alpha = 0.2) + 
  geom_vline(xintercept = c(2017-73), color = "black", lty = 2) +
  facet_wrap(~ Kon, labeller = labeller(Kon = c("1" = "Men", "2" = "Women")), ncol = 1, scales = "free_x", strip.position = "top") +
  scale_fill_manual(values = c("#225ea8", "#7fcdbb"), limits = c("FALSE", "TRUE"), labels = c("Deceased grandchildren", "Living grandchildren")) +
  #labs(x = "Birth cohort", y = "Average number of grandchildren", fill = "") +
  labs(x = "Birth cohort \n (Age in 2018)", y = "Proportion", fill = "")+
  #scale_x_continuous(breaks = c(seq(1920,2010, by = 10), 2017), sec.axis = sec_axis(~ 2018 - ., name = "Cohort age in 2018", breaks = c(seq(100,10, length.out = 10),1))) + 
  scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), labels = paste(c(seq(1920, 2010,by = 10), 2017), "\n", "(",2018 - c(seq(1920, 2010,by = 10), 2017),")")) +
  theme_bw() +
  theme(panel.grid.major.y = element_line(colour = "grey60", linewidth = 0.3, linetype = 9),
        panel.grid.major.x = element_line(colour = "grey60", linewidth = 0.3, linetype = 9),
        panel.grid.minor.x = element_line(colour = "grey60", linewidth = 0.3, linetype = 9),
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        panel.background = element_rect(fill = NA), 
        panel.ontop = TRUE,
        text = element_text(family = "Times", size = 12),
        legend.key = element_blank(),
        #strip.placement = "outside",
        strip.background = element_rect(color = "black", fill = "white")) +
  guides(fill = guide_legend(reverse = TRUE))

Q_alt <- ggplot(data = filter(grandchildren_dist_Table_living, IDbirthYear <= 2017)) +
  geom_area(mapping = aes(x = IDbirthYear, y = prop, fill = n_grandchildren), color = "grey30", lwd = 0.7) +
  geom_area(data=data.frame(x = c(2017-73,2017), y = c(1,1)), aes(x=x,y=y), fill = "white", alpha = 0.2) + 
  geom_vline(xintercept = c(2017-73), color = "black", lty = 2) +
  facet_wrap(~ Kon, labeller = labeller(Kon = c("1" = "Men", "2" = "Women")), ncol = 1, scales = "free_x", strip.position = "top") +
  #labs(x = "Birth cohort", y = "Proportion", fill = "")+
  labs(x = "Birth cohort \n (Age in 2018)", y = "Proportion", fill = "")+
  scale_fill_brewer(palette = "YlGnBu", direction = -1 ) + 
  #scale_x_continuous(breaks = c(seq(1920,2010, by = 10), 2017),sec.axis = sec_axis(~ 2018 - ., name = "Cohort age in 2018", breaks = c(seq(100,10, length.out = 10),1)))+
  scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), labels = paste(c(seq(1920, 2010,by = 10), 2017), "\n", "(",2018 - c(seq(1920, 2010,by = 10), 2017),")")) +
  scale_y_continuous(breaks = seq(0,1, by = 0.2))+
  theme_bw() + 
  guides(fill = guide_legend(reverse = TRUE, ncol = 3, byrow = TRUE)) + 
  theme(panel.grid.major.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.major.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        axis.line = element_line(),
        legend.position = "bottom",
        panel.background = element_rect(fill = NA), 
        panel.ontop = TRUE,
        text = element_text(family = "Times", size = 12),
        legend.key = element_blank(),
        #strip.placement = "outside",
        strip.background = element_rect(color = "black", fill = "white"))

plot_grid(Q, Q_alt, align = "hv")
```

#### Plot N: No. of children over cohort
#### Plot L: Mean children with n child bearing partners per cohort

```{r}
children_dist_Table <-  
  reference_table_SweBorn %>%
  filter(refGroup == "child" & IDbirthYear >= 1915 & IDbirthYear <= 2018) %>%
  left_join(., temp, by = c("IDbirthYear", "Kon")) %>%
  mutate(isAlive = refIDdeathYear >= 2017) %>% 
  setDT

children_dist_Table_living <- 
  rbind(
    children_dist_Table[is.na(refID),.(n_children = 0),keyby = .(ID, IDbirthYear, Kon, N_17)][,.(freq = .N),keyby = .(IDbirthYear, Kon, N_17, n_children)]
    , children_dist_Table[isAlive == TRUE & !is.na(refID),.(n_children = .N),keyby = .(ID, IDbirthYear, Kon, N_17)][,.(freq = .N),keyby = .(IDbirthYear, Kon, N_17, n_children)]
    ) %>%
  mutate(n_children = ifelse(n_children > 3, ">3", as.character(n_children)),
         n_children = factor(n_children, levels = c(">3","3","2","1","0")),
         n_children = fct_recode(n_children,
                                 "4 or more children" = ">3",
                                 "3 children" = "3",
                                 "2 children" = "2",
                                 "1 child" = "1",
                                 "No children" = "0")) %>%
  .[,.(freq =sum(freq)) ,keyby = .(IDbirthYear, Kon,  N_17, n_children)] %>%
  .[,.(n_children = n_children, freq = freq, N_17 = sum(freq), prop = freq /sum(freq)),keyby = .(IDbirthYear, Kon)]


child_table <- reference_table_SweBorn %>% 
  filter(refGroup == "child" & !is.na(refID) & IDbirthYear >= 1915 & IDbirthYear <= 2017) %>%
  mutate(isAlive = refIDdeathYear > 2017) %>%
  group_by(ID) %>%
  mutate(n_partners = max(refTypeIII),
         n_partners = ifelse(n_partners >2, ">2", as.character(n_partners)),
         n_partners = factor(n_partners, levels = c("1","2",">2"))) %>%
  ungroup() %>%
  setDT() %>% 
  left_join(., temp, by = c("IDbirthYear", "Kon"))

child_table <- rbind(child_table[, .(mean_children = .N / N_17, Type = "not living"),keyby = .(IDbirthYear, Kon)],
                     child_table[isAlive == TRUE, .(mean_children = .N / N_17),keyby = .(IDbirthYear, Type = n_partners, Kon)]) %>%
  distinct()

child_table <- child_table %>% mutate(Type = factor(Type, levels = c("not living", ">2", "2", "1")))

N <- ggplot(data = filter(children_dist_Table_living, IDbirthYear <= 2017)) +
  geom_area(mapping = aes(x = IDbirthYear, y = prop, fill = n_children), color = "grey30", lwd = 0.7) +
  geom_area(data=data.frame(x = c(2017-40,2017), y = c(1,1)), aes(x=x,y=y), fill = "white", alpha = 0.2) + 
  geom_vline(xintercept = c(2017-40), color = "black", lty = 2) +
  facet_wrap(~ Kon, labeller = labeller(Kon = c("1" = "Men", "2" = "Women")), ncol = 1, scales = "free_x") +
  #labs(x = "Birth cohort", y = "Proportion", fill = "")+
  labs(x = "Birth cohort \n(Age in 2018)", y = "Proportion", fill = "")+
  scale_fill_brewer(palette = "YlGnBu", direction = -1 ) + 
  #scale_x_continuous(breaks = c(seq(1920,2010, by = 10), 2017))+
  #scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), sec.axis = sec_axis(~ 2018 - ., name = "Cohort age in 2018", breaks = c(seq(100,10, length.out = 10),1))) +
  scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), labels = paste(c(seq(1920, 2010,by = 10), 2017), "\n", "(",2018 - c(seq(1920, 2010,by = 10), 2017),")")) +
  scale_y_continuous(breaks = seq(0,1, by = 0.2))+
  theme_bw() +
  guides(fill = guide_legend(reverse = TRUE, ncol = 3, nrow = 3, byrow = TRUE)) +
  theme(panel.grid.major.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.major.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        axis.line = element_line(),
        legend.position = "bottom",
        panel.background = element_rect(fill = NA), 
        panel.ontop = TRUE,
        text = element_text(family = "Times", size = 12),
        legend.key = element_blank(),
        strip.placement = "outside",
        strip.background = element_rect(color = "black", fill = "white"))

L_alt <- ggplot() +
  geom_area(data = child_table[Type == "not living"], mapping = aes(x = IDbirthYear, y = mean_children, fill = Type), color = "grey30", lwd = 0.5) +
  geom_area(data = child_table[Type != "not living"], mapping = aes(x = IDbirthYear, y = mean_children, fill = Type), color = "grey30", lwd = 0.5) +
  geom_area(data=data.frame(x = c(2017-40,2017), y = c(2.5,2.5)), aes(x=x,y=y), fill = "white", alpha = 0.2) + 
  geom_vline(xintercept = c(2017-40), color = "black", lty = 2) +
  facet_wrap(~ Kon, labeller = labeller(Kon = c("1" = "Men", "2" = "Women")), ncol = 1,scales = "free_x") +
  scale_fill_manual(values = c("#225ea8", "#41b6c4", "#7fcdbb","#ffffcc"), 
                    limits = c(">2", "2", "1","not living"), 
                    #limits = c(">2", "2", "1","not living"),
                    labels = c("Three or more childbearing partners", "Two childbearing partners", "One childbearing partner","Deceased children")) +
  #labels = c("Three or more childbearing partners", "Two childbearing partners", "One childbearing partner", "Deceased children")) +
  #labs(x = "Birth cohort", y = "Average number of children", fill = " ") +
  labs(x = "Birth cohort \n(Age in 2018)", y = "Average number of children", fill = " ") +
  theme_bw() +
  guides(fill = guide_legend(reverse = TRUE, ncol = 2, byrow = TRUE)) + 
  #scale_x_continuous(breaks = c(seq(1920, 2017, by = 10),2017)) + 
  #scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), sec.axis = sec_axis(~ 2018 - ., name = "Cohort age in 2018", breaks = c(seq(100,10, length.out = 10),1))) +
  scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), labels = paste(c(seq(1920, 2010,by = 10), 2017), "\n", "(",2018 - c(seq(1920, 2010,by = 10), 2017),")")) +
  theme(panel.grid.major.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.major.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        panel.background = element_rect(fill = NA), 
        panel.ontop = TRUE,
        text = element_text(family = "Times", size = 12),
        legend.key = element_blank(),
        strip.placement = "outside",
        strip.background = element_rect(color = "black", fill = "white"))

L_N <- plot_grid(L_alt, N, align = "hv")

L_N
```

#### Plot O: Mean sibling children per cohort

```{r}
sibchild_table <- reference_table_SweBorn %>% 
  filter(refGroup == "sibchild" & !is.na(refID) & IDbirthYear >= 1930 & IDbirthYear <= 2017) %>%
  mutate(isAlive = refIDdeathYear > 2017,
         Type = paste(refTypeIIII, refTypeIII, "side", sep = " "),
         Type = factor(Type, levels = c("half brother side","full brother side","half sister side","full sister side"))) %>%
  setDT() %>% 
  left_join(., select(N_Cohort, IDbirthYear, N_17), by = c("IDbirthYear"))


sibchild_table  <- rbind(sibchild_table[, .(mean_kin = .N / N_17, Type = "not living"),keyby = .(IDbirthYear)],
                         sibchild_table[isAlive == TRUE, .(mean_kin = .N / N_17),keyby = .(IDbirthYear, Type)]) %>%
  distinct()

O <- ggplot() +
  geom_area(data = filter(sibchild_table[Type == "not living"], IDbirthYear <= 2017), mapping = aes(x = IDbirthYear, y = mean_kin, fill = Type), color = "grey30", lwd = 0.5) +
  geom_area(data = filter(sibchild_table[Type != "not living"], IDbirthYear <= 2017), mapping = aes(x = IDbirthYear, y = mean_kin, fill = Type), color = "grey30", lwd = 0.5) +
  geom_area(data=data.frame(x = c(1930,1940), y = c(4.5,4.5)), aes(x=x,y=y), fill = "white", alpha = 0.25) + 
  geom_area(data=data.frame(x = c(2017-46,2017), y = c(4.5,4.5)), aes(x=x,y=y), fill = "white", alpha = 0.25) + 
  geom_vline(xintercept = c(1940, 2017-46), color = "black", lty = 2) +
  labs(x = "Birth cohort \n(Age in 2018)", y = "Average number of nieces/nephews", fill = "") +
  #labs(x = "Birth cohort", y = "Average number of nieces/nephews", fill = "") +
  scale_fill_manual(values = c("#a1dab4", "#41b6c4", "#2c7fb8", "#253494","white", "#ffffcc"),
                    limits = c(levels(sibchild_table$Type)[2:5], "", "not living"),
                    labels = c("Half brother's side","Full brother's side","Half sister's side","Full sister's side", "", "Deceased kin")) +
  #scale_x_continuous(breaks = c(seq(1930,2010, by = 10), 2017)) + 
  #scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), sec.axis = sec_axis(~ 2018 - ., name = "Cohort age in 2018", breaks = c(seq(100,10, length.out = 10),1))) +
  scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), labels = paste(c(seq(1920, 2010,by = 10), 2017), "\n", "(",2018 - c(seq(1920, 2010,by = 10), 2017),")")) +
  theme_bw() +
  theme(panel.grid.major.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.major.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor = element_line(colour = "grey70", size = 0.3, linetype = 9),
        legend.position = "right",
        legend.key.height = unit(1, "line"),
        panel.background = element_rect(fill = NA), 
        panel.ontop = TRUE,
        text = element_text(family = "Times", size = 12)) +
  guides(fill = guide_legend(override.aes = list(color = 0)))

O
```

#### Plot I: Mean siblings per cohort
#### Plot K: No. of siblings over cohort

```{r}
sibling_table <- reference_table_SweBorn %>% 
  filter(refGroup == "sibling" & !is.na(refID) & IDbirthYear >= 1930 & IDbirthYear <= 2017) %>%
  mutate(isAlive = refIDdeathYear > 2017) %>%
  setDT() %>% 
  left_join(., select(N_Cohort, IDbirthYear, N_17), by = c("IDbirthYear"))

sibling_table <- rbind(sibling_table[, .(mean_siblings = .N / N_17, refTypeIIII = "not living"),keyby = .(IDbirthYear)],
                       sibling_table[isAlive == TRUE, .(mean_siblings = .N / N_17),keyby = .(IDbirthYear, refTypeIIII)]) %>%
  distinct()


sibling_dist_Table <-  reference_table_SweBorn %>%
  filter(refGroup == "sibling" & IDbirthYear >= 1930 & IDbirthYear <= 2017) %>%
  left_join(., select(N_Cohort, IDbirthYear, N_17), by = c("IDbirthYear")) %>%
  mutate(isAlive = refIDdeathYear >= 2017) %>% 
  setDT

sibling_dist_Table_living <- rbind(sibling_dist_Table[is.na(refID),.(n_siblings = 0),keyby = .(ID, IDbirthYear, N_17)][,.(freq = .N),keyby = .(IDbirthYear, N_17, n_siblings)],
                                   sibling_dist_Table[isAlive == TRUE & !is.na(refID),.(n_siblings = .N),keyby = .(ID, IDbirthYear, N_17)][,.(freq = .N),keyby = .(IDbirthYear, N_17, n_siblings)]) %>%
  mutate(n_siblings = ifelse(n_siblings > 5, ">5", as.character(n_siblings)),
         n_siblings = factor(n_siblings, levels = c(">5","5","4","3","2","1","0")),
         n_siblings = fct_recode(n_siblings,
                                 "No siblings" = "0",
                                 "1 sibling" = "1",
                                 "2 siblings" = "2",
                                 "3 siblings" = "3",
                                 "4 siblings" = "4",
                                 "5 siblings" = "5",
                                 "6 or more siblings" = ">5")) %>%
  .[,.(freq =sum(freq)) ,keyby = .(IDbirthYear,  N_17, n_siblings)]%>%
  .[,.(n_siblings = n_siblings, freq = freq, N_17 = sum(freq), prop = freq /sum(freq)),keyby = .(IDbirthYear)]

K_alt <- ggplot(data = sibling_dist_Table_living) +
  geom_area(data = data.frame(IDbirthYear = seq(1930, 2017, by =1), new = 1), mapping = aes(x = IDbirthYear, y = new), fill = "#c7e9b4", color = "grey30", lwd = 0.7)  +
  geom_area(mapping = aes(x = IDbirthYear, y = prop, fill = n_siblings), color = "grey30", lwd = 0.7) +  
  geom_area(data=data.frame(x = c(1930,1940), y = c(1,1)), aes(x=x,y=y), fill = "white", alpha = 0.25) + 
  geom_area(data=data.frame(x = c(2017-13,2017), y = c(1,1)), aes(x=x,y=y), fill = "white", alpha = 0.25) + 
  geom_vline(xintercept = c(1940, 2017-13), color = "black", lty = 2) +
  #labs(x = "Birth cohort", y = "Proportion", fill = "")+
  labs(x = "Birth cohort \n(Age in 2018)", y = "Proportion", fill = "")+
  scale_fill_brewer(palette = "YlGnBu", direction = -1 ) + 
  #scale_x_continuous(breaks = c(seq(1930,2010, by = 10),2017))+
  #scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), sec.axis = sec_axis(~ 2018 - ., name = "Cohort age in 2018", breaks = c(seq(100,10, length.out = 10),1))) +
  scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), labels = paste(c(seq(1920, 2010,by = 10), 2017), "\n", "(",2018 - c(seq(1920, 2010,by = 10), 2017),")")) +
  scale_y_continuous(breaks = seq(0,1, by = 0.2))+
  theme_bw() +
  theme(panel.grid.major.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.major.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        legend.position = "bottom",
        panel.background = element_rect(fill = NA), 
        panel.ontop = TRUE,
        text = element_text(family = "Times", size = 12))+
  guides(fill = guide_legend(reverse = TRUE, nrow = 2, byrow = TRUE))


I_alt <- ggplot() +
  geom_area(data = sibling_table[refTypeIIII == "not living"], mapping = aes(x = IDbirthYear, y = mean_siblings, fill = refTypeIIII), color = "grey30", lwd = 0.5) +
  geom_area(data = sibling_table[refTypeIIII != "not living"], mapping = aes(x = IDbirthYear, y = mean_siblings, fill = refTypeIIII), color = "grey30", lwd = 0.5) +
  geom_area(data=data.frame(x = c(1930,1940), y = c(2.5,2.5)), aes(x=x,y=y), fill = "white", alpha = 0.25) + 
  geom_area(data=data.frame(x = c(2017-13,2017), y = c(2.5,2.5)), aes(x=x,y=y), fill = "white", alpha = 0.25) + 
  geom_vline(xintercept = c(1940, 2017-13), color = "black", lty = 2) +
  scale_fill_manual(values = c("#225ea8", "#41b6c4", "#a1dab4","#ffffcc"), 
                    limits = c("full", "half.father", "half.mother","not living"), 
                    labels = c("Full siblings", "Half siblings on father's side", "Half siblings on mother's side","Deceased siblings")) +
  #labs(x = "Birth cohort", y = "Average number of siblings", fill = "") +
  labs(x = "Birth cohort \n(Age in 2018)", y = "Average number of siblings", fill = "") +
  #scale_x_continuous(breaks = c(seq(1930,2010, by = 10), 2017)) + 
  #scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), sec.axis = sec_axis(~ 2018 - ., name = "Cohort age in 2018", breaks = c(seq(100,10, length.out = 10),1))) +
  scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), labels = paste(c(seq(1920, 2010,by = 10), 2017), "\n", "(",2018 - c(seq(1920, 2010,by = 10), 2017),")")) +
  theme_bw() +
  theme(panel.grid.major.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.major.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor = element_line(colour = "grey70", size = 0.3, linetype = 9),
        legend.position = "bottom",
        panel.background = element_rect(fill = NA), 
        panel.ontop = TRUE,
        text = element_text(family = "Times", size = 12)) +
  guides(fill = guide_legend(ncol = 2, byrow = TRUE, reverse = TRUE))



I_K <- plot_grid(I_alt, K_alt)

I_K
```

#### Plot G1 + G2: Mean Cousins per cohort
#### Plot H1

```{r}
cousin_table <- reference_table_SweBorn %>% 
  filter(refGroup == "cousin" & !is.na(refID) & IDbirthYear >= 1950 & IDbirthYear <= 2017) %>%
  mutate(isAlive = refIDdeathYear > 2017,
         Type    = paste(refTypeIII, refTypeIIII, sep = "_"),
         Type = factor(Type),
         Type = fct_recode(Type,
                           "Father's brother's side, one shared grandparent"  = "father.brother_1" ,
                           "Father's brother's side, two shared grandparents" = "father.brother_2" ,
                           "Father's sister's side, one shared grandparent"   = "father.sister_1"  ,
                           "Father's sister's side, two shared grandparents"  = "father.sister_2"  ,
                           "Mother's brother's side, one shared grandparent"  = "mother.brother_1" ,
                           "Mother's brother's side, two shared grandparents" = "mother.brother_2" ,
                           "Mother's sister's side, one shared grandparent"   = "mother.sister_1"  ,
                           "Mother's sister's side, two shared grandparents"  = "mother.sister_2"),
         Type2 = fct_recode(Type,
                            "Father's side, one shared grandparent"  = "Father's brother's side, one shared grandparent" ,
                            "Father's side, two shared grandparents" = "Father's brother's side, two shared grandparents" ,
                            "Father's side, one shared grandparent"  = "Father's sister's side, one shared grandparent",
                            "Father's side, two shared grandparents" = "Father's sister's side, two shared grandparents"  ,
                            "Mothers's side, one shared grandparent" = "Mother's brother's side, one shared grandparent" ,
                            "Mothers's side, two shared grandparents"= "Mother's brother's side, two shared grandparents" ,
                            "Mothers's side, one shared grandparent" = "Mother's sister's side, one shared grandparent",
                            "Mothers's side, two shared grandparents"= "Mother's sister's side, two shared grandparents"),
         Type3 = refTypeIIII,
         Type4 = refTypeIII) %>%
  setDT() %>% 
  left_join(., select(N_Cohort, IDbirthYear, N_17), by = c("IDbirthYear"))

cousin_tableAlt3 <- rbind(cousin_table[, .(mean_cousins = .N / N_17, Type4 = "not living"),keyby = .(IDbirthYear)],
                          cousin_table[isAlive == TRUE, .(mean_cousins = .N / N_17),keyby = .(IDbirthYear, Type4)]) %>%
  distinct()

cousin_dist_Table <-  reference_table_SweBorn %>%
  filter(refGroup == "cousin" & IDbirthYear >= 1950 & IDbirthYear <= 2017) %>%
  left_join(., select(N_Cohort, IDbirthYear, N_17), by = c("IDbirthYear")) %>%
  mutate(isAlive = refIDdeathYear >= 2017) %>% 
  setDT

cousin_dist_Table_living <- rbind(cousin_dist_Table[is.na(refID),.(n_cousins = 0),keyby = .(ID, IDbirthYear, N_17)][,.(freq = .N),keyby = .(IDbirthYear, N_17, n_cousins)],
                                  cousin_dist_Table[isAlive == TRUE & !is.na(refID),.(n_cousins = .N),keyby = .(ID, IDbirthYear, N_17)][,.(freq = .N),keyby = .(IDbirthYear, N_17, n_cousins)]) %>%
  mutate(n_cousins = ifelse(n_cousins > 5 & n_cousins < 11,"6-10",ifelse(n_cousins > 10,">10",as.character(n_cousins))),
         n_cousins = factor(n_cousins, levels = c(">10","6-10","5","4","3","2","1","0")),
         n_cousins = fct_recode(n_cousins,
                                "No cousins" = "0",
                                "1 cousin" = "1",
                                "2 cousins" = "2",
                                "3 cousins" = "3",
                                "4 cousins" = "4",
                                "5 cousins" = "5",
                                "6 - 10 cousins" = "6-10",
                                "11 or more cousins" = ">10")) %>%
  .[,.(freq =sum(freq)) ,keyby = .(IDbirthYear,  N_17, n_cousins)]%>%
  .[,.(n_cousins = n_cousins, freq = freq, N_17 = sum(freq), prop = freq /sum(freq)),keyby = .(IDbirthYear)]


G1_alt <- ggplot() +
  geom_area(data = cousin_tableAlt3[Type4 == "not living"], mapping = aes(x = IDbirthYear, y = mean_cousins, fill = Type4), color = "grey30", lwd = 0.5) +
  geom_area(data = cousin_tableAlt3[Type4 != "not living"], mapping = aes(x = IDbirthYear, y = mean_cousins, fill = Type4), color = "grey30", lwd = 0.5) +
  geom_area(data=data.frame(x = c(1950,1977), y = c(0,8.5)), aes(x=x,y=y), fill = "white", alpha = 0.2) + 
  geom_area(data=data.frame(x = c(2017-19,2017), y = c(7,7)), aes(x=x,y=y), fill = "white", alpha = 0.2) + 
  geom_vline(xintercept = c(1977, 2017-19), color = "black", lty = 2) +
  scale_fill_manual(values = c("#253494", "#2c7fb8", "#41b6c4", "#a1dab4","#ffffcc"), 
                    limits = c(levels(as.factor(cousin_tableAlt3$Type4))[1:4],"not living"),
                    labels = c("Paternal uncle's side","Paternal aunt's side", "Maternal uncle's side","Maternal aunt's side","Deceased cousins")) +
  #labs(x = "Birth cohort", y = "Average number of cousins", fill = "") +
  labs(x = "Birth cohort \n(Age in 2018)", y = "Average number of cousins", fill = "") +
  #scale_x_continuous(breaks = c(seq(1950,2010, by = 10), 2017)) + 
  #scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), sec.axis = sec_axis(~ 2018 - ., name = "Cohort age in 2018", breaks = c(seq(100,10, length.out = 10),1))) +
  scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), labels = paste(c(seq(1920, 2010,by = 10), 2017), "\n", "(",2018 - c(seq(1920, 2010,by = 10), 2017),")")) +
  theme_bw() +
  theme(panel.grid.major.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.major.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor = element_line(colour = "grey70", size = 0.3, linetype = 9),
        legend.position = "bottom",
        panel.background = element_rect(fill = NA), 
        panel.ontop = TRUE,
        text = element_text(family = "Times", size = 12)) +
  guides(fill = guide_legend(reverse = TRUE, ncol = 3, byrow = TRUE))

H_alt <- ggplot(data = cousin_dist_Table_living) +
  geom_area(mapping = aes(x = IDbirthYear, y = prop, fill = n_cousins), color = "grey30", lwd = 0.7) +  
  geom_area(data=data.frame(x = c(1950,1977), y = c(1,1)), aes(x=x,y=y), fill = "white", alpha = 0.2) + 
  geom_area(data=data.frame(x = c(2017-19,2017), y = c(1,1)), aes(x=x,y=y), fill = "white", alpha = 0.2) + 
  geom_vline(xintercept = c(1977, 2017-19), color = "black", lty = 2) +
  #labs(x = "Birth cohort", y = "Proportion", fill = "")+
  labs(x = "Birth cohort \n(Age in 2018)", y = "Proportion", fill = "")+
  scale_fill_brewer(palette = "YlGnBu", direction = -1 ) + 
  #scale_x_continuous(breaks = c(seq(1950,2010, by = 10),2017))+
  #scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), sec.axis = sec_axis(~ 2018 - ., name = "Cohort age in 2018", breaks = c(seq(100,10, length.out = 10),1))) +
  scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), labels = paste(c(seq(1920, 2010,by = 10), 2017), "\n", "(",2018 - c(seq(1920, 2010,by = 10), 2017),")")) +
  scale_y_continuous(breaks = seq(0,1, by = 0.2))+
  theme_bw() +
  guides(fill = guide_legend(reverse = TRUE, nrow = 3, byrow = TRUE)) +
  theme(panel.grid.major.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.major.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        legend.position = "bottom",
        panel.background = element_rect(fill = NA), 
        panel.ontop = TRUE,
        text = element_text(family = "Times", size = 12))

G1_H <- plot_grid(G1_alt, H_alt, align = "hv")

G1_H
```

#### Plot D1 + D2: Mean parents per cohort

```{r}
parent_table <- 
  reference_table_SweBorn %>% 
  filter(refGroup == "parent" & !is.na(refID) & IDbirthYear >= 1930 & IDbirthYear <= 2017) %>%
  filter(!is.na(refIDdeathYear)) %>% 
  mutate(
    isAlive = refIDdeathYear > 2017
    , refTypeII = ifelse(!isAlive, "not living", refTypeII)
    , Type = as.factor(refTypeII)
    ) %>%
  setDT() %>% 
  left_join(., select(N_Cohort, IDbirthYear, N_17), by = c("IDbirthYear"))

# Q: Why are some Type = "not living")??

parent_table  <- 
  rbind(
    parent_table[isAlive == TRUE, .(mean_kin = .N / N_17),keyby = .(IDbirthYear, Type)]
    , parent_table[, .(mean_kin = .N / N_17, Type = "not living"),keyby = .(IDbirthYear)]
    ) %>%
  distinct() %>% 
  mutate(new = 2)

D1 <-
  ggplot() +
  # geom_area(data = parent_table[Type == "not living"], mapping = aes(x = IDbirthYear, y = new), fill = "#fed98e") +
  geom_area(data = parent_table[Type == "not living"], mapping = aes(x = IDbirthYear, y = mean_kin, fill = Type), color = "grey30", lwd = 0.5) +
  geom_area(data = parent_table[Type != "not living"], mapping = aes(x = IDbirthYear, y = mean_kin, fill = Type), color = "grey30", lwd = 0.5) +
  # geom_area(data=data.frame(x = c(1932,1940), y = c(2,2)), aes(x=x,y=y), fill = "white", alpha = 0.25) +
  geom_vline(xintercept = c(1940), color = "black", lty = 2) +
  labs(x = "Birth cohort \n(Age in 2018)", y = "Average number of parents", fill = "") +
  scale_fill_manual(values = c("#2c7fb8", "#a1dab4","#ffffcc"),
                    limits = c(levels(parent_table$Type)),
                    labels = c("Fathers", "Mothers", "Registered deceased parents")) +
  scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), labels = paste(c(seq(1920, 2010,by = 10), 2017), "\n", "(",2018 - c(seq(1920, 2010,by = 10), 2017),")")) +
  theme_bw() +
  theme(panel.grid.major.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.major.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor = element_line(colour = "grey70", size = 0.3, linetype = 9),
        legend.position = "bottom",
        legend.key.height = unit(1, "line"),
        panel.background = element_rect(fill = NA), 
        panel.ontop = TRUE,
        text = element_text(family = "Times", size = 12)) +
  #guides(fill = guide_legend(override.aes = list(color = 0))) 
  guides(fill = guide_legend(override.aes = list(color = 0), ncol = 2, byrow = TRUE))

D1
```

#### Plot E1 + E2: Mean parent siblings per cohort

```{r}
parsib_table <- reference_table_SweBorn %>% 
  filter(refGroup == "parsib" & !is.na(refID) & IDbirthYear >= 1950 & IDbirthYear <= 2017) %>%
  mutate(isAlive = refIDdeathYear > 2017,
         Type =  paste(refTypeIII, "'s ", refTypeIIII, " sibling's", " side", sep = ""),
         Type = factor(Type, levels = c("father's half sibling's side", "father's full sibling's side","mother's half sibling's side", "mother's full sibling's side")),
         refTypeII = case_when(refTypeII == "aunt" ~ "sister",
                               refTypeII == "uncle" ~ "brother",
                               TRUE ~ refTypeII),
         Type2  = paste(refTypeIII, "'s ", refTypeIIII," ", refTypeII, "'s", " side", sep = ""),
         Type2 = factor(Type2, levels = c("father's half brother's side",
                                          "father's full brother's side",
                                          "father's half sister's side",
                                          "father's full sister's side",
                                          "mother's half brother's side",
                                          "mother's full brother's side",
                                          "mother's half sister's side",
                                          "mother's full sister's side")),
         Type3 = refTypeIIII,
         Type4 = paste(refTypeIII, refTypeII, sep = " ")) %>%
  setDT() %>% 
  left_join(., select(N_Cohort, IDbirthYear, N_17), by = c("IDbirthYear"))

parsib_tableAlt3  <- rbind(parsib_table[, .(mean_kin = .N / N_17, Type4 = "not living"),keyby = .(IDbirthYear)],
                           parsib_table[isAlive == TRUE, .(mean_kin = .N / N_17),keyby = .(IDbirthYear, Type4)]) %>%
  distinct()


E1 <- ggplot() +
  geom_area(data = parsib_tableAlt3[Type4 == "not living"], mapping = aes(x = IDbirthYear, y = mean_kin, fill = Type4), color = "grey30", lwd = 0.5) +
  geom_area(data = parsib_tableAlt3[Type4 != "not living"], mapping = aes(x = IDbirthYear, y = mean_kin, fill = Type4), color = "grey30", lwd = 0.5) +
  geom_area(data=data.frame(x = c(1950,1977), y = c(0,5)), aes(x=x,y=y), fill = "white", alpha = 0.2) + 
  geom_vline(xintercept = c(1977), color = "black", lty = 2) +
  #labs(x = "Birth cohort", y = "Average number of aunts/uncles", fill = "") +
  labs(x = "Birth cohort \n(Age in 2018)", y = "Average number of aunts/uncles", fill = "") +
  #scale_fill_manual(values = c("#a1dab4", "#41b6c4", "#2c7fb8", "#253494","white", "#ffffcc"),
   #                 limits = c(levels(as.factor(parsib_tableAlt3$Type4))[1:4], "", "not living"),
    #                labels = c("Paternal uncle", "Paternal aunt", "Maternal uncle", "Maternal aunt", "", "Deceased parental siblings")) +
  scale_fill_manual(values = c("#a1dab4", "#41b6c4", "#2c7fb8", "#253494", "#ffffcc"),
                    limits = c(levels(as.factor(parsib_tableAlt3$Type4))[1:4], "not living"),
                    labels = c("Paternal uncle", "Paternal aunt", "Maternal uncle", "Maternal aunt","Deceased parental siblings")) +
  #scale_x_continuous(breaks = c(seq(1950,2010, by = 10), 2017)) + 
  #scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), sec.axis = sec_axis(~ 2018 - ., name = "Cohort age in 2018", breaks = c(seq(100,10, length.out = 10),1))) +
  scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), labels = paste(c(seq(1920, 2010,by = 10), 2017), "\n", "(",2018 - c(seq(1920, 2010,by = 10), 2017),")")) +
  theme_bw() +
  theme(panel.grid.major.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.major.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor = element_line(colour = "grey70", size = 0.3, linetype = 9),
        #legend.position = "right",
        legend.position = "bottom",
        legend.key.height = unit(1, "line"),
        panel.background = element_rect(fill = NA), 
        panel.ontop = TRUE,
        text = element_text(family = "Times", size = 12)) +
  #guides(fill = guide_legend(override.aes = list(color = 0)))
  guides(fill = guide_legend(override.aes = list(color = 0), ncol = 2, byrow = TRUE))


plot_grid(D1, E1, align = "hv")
```

#### Plot B1: Mean grandparents per cohort 

```{r}
grandparent_table <- 
  reference_table_SweBorn %>% 
  filter(refGroup == "grandparent" & !is.na(refID) & IDbirthYear >= 1950 & IDbirthYear <= 2017) %>%
  mutate(isAlive = refIDdeathYear > 2017,
         Type  = paste(refTypeII, " (", refTypeIII, "'s side)", sep = ""),
         Type2 = paste(refTypeIII, "'s side", sep = "")) %>%
  setDT() %>% 
  left_join(., select(N_Cohort, IDbirthYear, N_17), by = c("IDbirthYear"))

grandparent_table  <- 
  rbind(
    grandparent_table[, .(mean_kin = .N / N_17, Type = "not living"),keyby = .(IDbirthYear)]
    , grandparent_table[isAlive == TRUE, .(mean_kin = .N / N_17),keyby = .(IDbirthYear, Type)]
    ) %>%
  distinct() 
  # mutate(new = 4)

B1 <-
  ggplot() +
  # geom_area(data = grandparent_table[Type == "not living"], mapping = aes(x = IDbirthYear, y = new), fill = "#fed98e", color = "grey30") +
  geom_area(data = grandparent_table[Type == "not living"], mapping = aes(x = IDbirthYear, y = mean_kin, fill = Type), color = "grey30", lwd = 0.5) +
  geom_area(data = grandparent_table[Type != "not living"], mapping = aes(x = IDbirthYear, y = mean_kin, fill = Type), color = "grey30", lwd = 0.5) +
  # geom_area(data=data.frame(x = c(1950,1977), y = c(4,4)), aes(x=x,y=y), fill = "white", alpha = 0.2) 
  geom_vline(xintercept = c(1977), color = "black", lty = 2) +
  scale_fill_manual(values = c("#a1dab4","#41b6c4","#2c7fb8","#253494", "#ffffcc")
                    , limits = c(levels(as.factor(grandparent_table$Type))[1:4],  "not living")
                    , labels = c("Paternal grandfather", "Maternal grandfather", "Paternal grandmother", "Maternal grandfather", "Registered deceased grandparents")
                    ) +
  labs(x = "Birth cohort \n(Age in 2018)", y = "Average number of grandparents", fill = "") +
  scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), labels = paste(c(seq(1920, 2010,by = 10), 2017), "\n", "(",2018 - c(seq(1920, 2010,by = 10), 2017),")")) +
  theme_bw() +
  theme(panel.grid.major.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.major.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor = element_line(colour = "grey70", size = 0.3, linetype = 9),
        legend.position = "bottom",
        legend.key.height = unit(1, "line"),
        panel.background = element_rect(fill = NA), 
        panel.ontop = TRUE,
        text = element_text(family = "Times", size = 12)) +
  guides(fill = guide_legend(override.aes = list(color = 0), ncol = 2, byrow = TRUE))


plot_grid(D1, B1, align = "hv")
```

#### Plot S: Mean total kin per cohort 

```{r}
totalkin_table <- reference_table_SweBorn %>% 
  filter(!is.na(refID) & IDbirthYear >= 1915 & IDbirthYear <= 2017) %>%
  mutate(isAlive = refIDdeathYear > 2017,
         Type = as.factor(refGroup)) %>%
  setDT() %>% 
  left_join(., select(N_Cohort, IDbirthYear, N_17), by = c("IDbirthYear"))


totalkin_table  <- rbind(totalkin_table[, .(mean_kin = .N / N_17, Type = "not living"),keyby = .(IDbirthYear)],
                         totalkin_table[isAlive == TRUE, .(mean_kin = .N / N_17),keyby = .(IDbirthYear, Type)]) %>%
  distinct()%>%
  mutate(Type = factor(Type, levels = c("not living", "grandchild","child","sibchild","sibling","cousin","parent","parsib","grandparent")))


totalkin_table <- rbind(totalkin_table, data.frame(IDbirthYear = 1931,
                                                   mean_kin = 0,
                                                   Type = c("sibchild", "sibling")))

S <- ggplot() +
  geom_area(data = totalkin_table[Type == "not living"], mapping = aes(x = IDbirthYear, y = mean_kin, fill = Type), color = "grey30", lwd = 0.5) +
  #geom_area(data=data.frame(x = c(1931,1932), y = c(0,3)), aes(x=x,y=y), fill = "#225ea8") + 
  geom_area(data = totalkin_table[Type != "not living"], mapping = aes(x = IDbirthYear, y = mean_kin, fill = Type), color = "grey30", lwd = 0.5) +
  #geom_area(data=data.frame(x = c(1915,1932), y = c(25,25)), aes(x=x,y=y), fill = "white", alpha = 0.1) + 
  #labs(x = "Birth cohort", y = "Average number of kin", fill = "") +
  labs(x = "Birth cohort \n(Age in 2018)", y = "Average number of kin", fill = "") +
  scale_fill_manual(values =c("#081d58","#253494","#225ea8","#1d91c0","#41b6c4","#7fcdbb","#c7e9b4","#edf8b1","white","#ffffd9"),
                    limits = c(levels(totalkin_table$Type)[2:9], "", "not living"),
                    labels = c("Grandchilden", "Childen", "Nieces/nephews", "Siblings", "Cousins", "Parents", "Aunts/Uncles", "Grandparents", "", "Dead kin")) +
  #scale_x_continuous(breaks = c(seq(1920,2010, by = 10), 2017)) + 
  #scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), sec.axis = sec_axis(~ 2018 - ., name = "Cohort age in 2018", breaks = c(seq(100,10, length.out = 10),1))) +
  scale_x_continuous(breaks   = c(seq(1920, 2010,by = 10), 2017), labels = paste(c(seq(1920, 2010,by = 10), 2017), "\n", "(",2018 - c(seq(1920, 2010,by = 10), 2017),")")) +
  theme_bw() +
  theme(panel.grid.major.y = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.major.x = element_line(colour = "grey60", size = 0.3, linetype = 9),
        panel.grid.minor = element_line(colour = "grey70", size = 0.3, linetype = 9),
        legend.position = "right",
        legend.key.height = unit(1, "line"),
        panel.background = element_rect(fill = NA), 
        panel.ontop = TRUE,
        text = element_text(family = "Times", size = 12)) +
  guides(fill = guide_legend(override.aes = list(color = 0)))

S
```

#### Plot T + W: Violin plots (number of total kin)

```{r}
violinTable_kin <- reference_table_SweBorn %>%
  filter(!is.na(refID) & IDbirthYear %in% c(1920, 1930, 1940, 1950, 1960, 1970, 1980,1990,2000, 2010)) %>%
  #filter(!is.na(refID)) %>%
  mutate(isAlive = refIDdeathYear >= 2018) %>%
  left_join(., select(N_Cohort, IDbirthYear, N_17), by = "IDbirthYear") %>%
  setDT()

violinTable_kin_living  <- violinTable_kin[isAlive == TRUE,.(n = .N),keyby = .(IDbirthYear,ID, N_17)][,.(freq = .N),.(IDbirthYear,N_17,n)] %>%
  rbind(.,.[,.(n=0, freq = N_17 - sum(freq)),keyby = .(IDbirthYear, N_17)]) %>% 
  arrange(IDbirthYear, n)

violinTable_kin  <- violinTable_kin[,.(n = .N),keyby = .(IDbirthYear,ID, N_17)][,.(freq = .N),.(IDbirthYear,N_17,n)] %>%
  rbind(.,.[,.(n=0, freq = N_17 - sum(freq)),keyby = .(IDbirthYear, N_17)]) %>% 
  arrange(IDbirthYear, n)

boxplotTable_kin_living <- violinTable_kin_living[,.(n = n, q=cumsum(freq/N_17)),keyby = .(IDbirthYear, N_17)] %>%
  mutate(lim = ifelse(q > 0.025, "qmin"   , FALSE),
         lim = ifelse(q > 0.25 , "qlower" , lim),
         lim = ifelse(q > 0.5  , "qmiddle", lim),
         lim = ifelse(q > 0.75 , "qupper" , lim),
         lim = ifelse(q > 0.975, "qmax"   , lim)) %>%
  distinct(IDbirthYear, lim, .keep_all = TRUE) %>%
  select(IDbirthYear,lim, n)  %>%
  dcast(.,IDbirthYear ~ lim, value.var = "n")

boxplotTable_kin <- violinTable_kin[,.(n = n, q=cumsum(freq/N_17)),keyby = .(IDbirthYear, N_17)] %>%
  mutate(lim = ifelse(q > 0.025, "qmin"   , FALSE),
         lim = ifelse(q > 0.25 , "qlower" , lim),
         lim = ifelse(q > 0.5  , "qmiddle", lim),
         lim = ifelse(q > 0.75 , "qupper" , lim),
         lim = ifelse(q > 0.975, "qmax"   , lim)) %>%
  distinct(IDbirthYear, lim, .keep_all = TRUE) %>%
  select(IDbirthYear,lim, n)  %>%
  dcast(.,IDbirthYear ~ lim, value.var = "n")

annotate_living <-left_join(select(boxplotTable_kin_living, IDbirthYear, qmiddle), violinTable_kin_living, by = c("IDbirthYear"="IDbirthYear", "qmiddle"="n" ))


PlotT <- ggplot() +
  geom_violin(data  = violinTable_kin_living,  mapping = aes(x = IDbirthYear, y = n, weight = freq, fill = as.factor(IDbirthYear)),
              scale = "area", bw = 1) +
  geom_boxplot(data = boxplotTable_kin_living, mapping = aes(x = IDbirthYear,ymin = qmin, lower = qlower, middle = qmiddle, upper = qupper, ymax = qmax, fill = as.factor(IDbirthYear)),stat = "identity", 
               width = 1.5, show.legend = FALSE, color = "maroon")+
  scale_fill_manual(values = c("white", "#ffffd9", "#edf8b1", "#c7e9b4", "#7fcdbb", "#41b6c4", "#1d91c0", "#225ea8", "#253494", "#081d58"))+ 
  #labs(x = "Birth cohort", y = "Total number of living kin") +
  labs(x = "Birth cohort \n(Age in 2018)", y = "Total number of living kin") +
  scale_y_continuous(breaks = seq(0,80, by = 10), limits = c(0,70)) + 
  #scale_x_continuous(breaks = seq(1920, 2010, by=10), labels = seq(1920, 2010, by=10), sec.axis = dup_axis(name = "Percentage of cohort population with median number of kin", labels = round( 100* annotate_living$freq / annotate_living$N_17, 2)))+
  scale_x_continuous(breaks   = seq(1920, 2010, by=10), 
                     labels = paste(seq(1920, 2010, by=10), "\n", "(",2018 -seq(1920, 2010, by=10),")"),
                     sec.axis = dup_axis(name = "Percentage of cohort population with median number of kin", labels = round( 100* annotate_living$freq / annotate_living$N_17, 2))) +
  theme_bw() +
  #geom_text(data = annotate_living , aes(x = as.factor(IDbirthYear), y = 70, label = round( 100* freq / N_17, 2)), size = 3) +
  #coord_cartesian(clip = "off") +
  theme(panel.grid.major.y = element_line(colour = "grey70", size = 0.3, linetype = 9),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_line(colour = "grey70", size = 0.3, linetype = 9),
        panel.grid.minor.x = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = NA), 
        panel.ontop = TRUE,
        text = element_text(family = "Times", size = 12)) 


PlotT
```